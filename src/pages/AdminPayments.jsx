// src/pages/AdminPayments.jsx
import React, { useState, useEffect, useMemo } from 'react';
import { FiDollarSign, FiRefreshCw, FiCalendar } from 'react-icons/fi';
import styles from './AdminPayments.module.css';
import { getAllPayments, getAllUsers } from '../api';

const AdminPayments = () => {
    const [payments, setPayments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [paymentTypeFilter, setPaymentTypeFilter] = useState('ALL');
    const [statusFilter, setStatusFilter] = useState('ALL');
    const [month, setMonth] = useState(new Date().getMonth() + 1);
    const [year, setYear] = useState(new Date().getFullYear());
    const [selectedUser, setSelectedUser] = useState(null);
    const [users, setUsers] = useState([]);
    const [notification, setNotification] = useState(null);

    const paymentTypes = {
        WATER: 'ููุงู',
        ARNONA: 'ุฃุฑูููุง',
        KINDERGARTEN: 'ุญุถุงูุฉ',
        ALL: 'ุงููู'
    };

    const statusVariants = {
        PENDING: 'badgePending',
        PAID: 'badgePaid',
        COMPLETED: 'badgePaid',
        OVERDUE: 'badgeOverdue',
        ALL: ''
    };

    const statusLabels = {
        PENDING: 'ููุฏ ุงูุงูุชุธุงุฑ',
        PAID: 'ุชู ุงูุฏูุน',
        COMPLETED: 'ููุชูู',
        OVERDUE: 'ูุชุฃุฎุฑ',
        ALL: 'ุงููู'
    };

    const formatDate = (dateValue) => {
        if (!dateValue) return '--';
        try {
            const date = new Date(dateValue);
            return isNaN(date.getTime()) ? '--' : date.toLocaleDateString('ar-SA');
        } catch (e) {
            console.error('Error formatting date:', e);
            return '--';
        }
    };

    useEffect(() => {
        const fetchUsers = async () => {
            try {
                const response = await getAllUsers();
                if (Array.isArray(response)) {
                    setUsers(response);
                } else {
                    console.error('Expected array but got:', response);
                    setNotification({
                        type: 'danger',
                        message: 'ุจูุงูุงุช ุงููุณุชุฎุฏููู ุบูุฑ ุตุงูุญุฉ'
                    });
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                setNotification({
                    type: 'danger',
                    message: 'ูุดู ูู ุชุญููู ุงููุณุชุฎุฏููู'
                });
            }
        };
        fetchUsers();
    }, []);

    useEffect(() => {
        loadPayments();
    }, [month, year, selectedUser, users]);

    const loadPayments = async () => {
        setLoading(true);
        try {
            const response = await getAllPayments(month, year, selectedUser);

            // ุชุญูู ุฌูุฏ ูู ุฃู ุงูุจูุงูุงุช ูุตูููุฉ
            if (!Array.isArray(response)) {
                console.error('Expected array but got:', response);
                setNotification({
                    type: 'danger',
                    message: 'ุจูุงูุงุช ุงููุฏููุนุงุช ุบูุฑ ุตุงูุญุฉ'
                });
                setPayments([]);
                return;
            }

            const enhanced = response.map((p) => ({
                ...p,
                paymentId: p.payment_id || p.paymentId || p.id || Math.random().toString(36).substr(2, 9),
                userId: p.user_id || p.userId || '--',
                paymentType: p.type || p.paymentType || 'UNKNOWN',
                paymentDate: p.payment_date || p.paymentDate || null,
                amount: p.amount || p.fee || 0,
                status: p.status || 'PENDING',
                date: p.date || p.due_date || null,
                fullName: p.fullName ||
                    (users.find((u) => u.user_id === (p.user_id || p.userId))?.fullName ||
                    'ุบูุฑ ูุนุฑูู')
            }));

            setPayments(enhanced);
            setNotification(null);
        } catch (error) {
            console.error('๐จ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฏูุนุงุช:', error);
            setNotification({
                type: 'danger',
                message: error.message || 'ูุดู ูู ุชุญููู ุงูุฏูุนุงุช',
            });
            setPayments([]);
        } finally {
            setLoading(false);
        }
    };

    const filteredPayments = useMemo(() => {
        if (!Array.isArray(payments)) return [];

        let result = [...payments];
        if (paymentTypeFilter !== 'ALL') {
            result = result.filter(p => p.paymentType === paymentTypeFilter);
        }
        if (statusFilter !== 'ALL') {
            result = result.filter(p => p.status === statusFilter);
        }
        return result;
    }, [payments, paymentTypeFilter, statusFilter]);

    const handleRefresh = () => {
        loadPayments();
    };

    return (
        <div className={styles.bgContainer}>
            <div className={styles.card}>
                {/* Header */}
                <div className={styles.header}>
                    <div className={styles.headerTitle}>
                        <FiDollarSign />
                        <h1>ุฅุฏุงุฑุฉ ุงููุฏููุนุงุช - ุจูุฏูุฉ ุฃู ุจุทูู</h1>
                    </div>

                    <button
                        onClick={handleRefresh}
                        disabled={loading}
                        className={`${styles.btn} ${styles.btnLight}`}
                    >
                        <FiRefreshCw className={loading ? styles.spinner : ''} />
                        ุชุญุฏูุซ ุงูุจูุงูุงุช
                    </button>
                </div>

                {/* Filters */}
                <div className={styles.filters}>
                    <div className={styles.filterGroup}>
                        <select
                            value={selectedUser || ''}
                            onChange={(e) => setSelectedUser(e.target.value || null)}
                            className={styles.filterSelect}
                        >
                            <option value="">ุฌููุน ุงููุณุชุฎุฏููู</option>
                            {Array.isArray(users) && users.map(user => (
                                <option key={`user-${user.user_id}`} value={user.user_id}>
                                    {user.fullName}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div className={styles.filterGroup}>
                        <select
                            value={month}
                            onChange={(e) => setMonth(parseInt(e.target.value))}
                            className={styles.filterSelect}
                        >
                            {Array.from({ length: 12 }, (_, i) => (
                                <option key={`month-${i + 1}`} value={i + 1}>
                                    ุงูุดูุฑ {i + 1}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div className={styles.filterGroup}>
                        <select
                            value={year}
                            onChange={(e) => setYear(parseInt(e.target.value))}
                            className={styles.filterSelect}
                        >
                            {Array.from({ length: 5 }, (_, i) => (
                                <option key={`year-${i}`} value={new Date().getFullYear() - 2 + i}>
                                    ุณูุฉ {new Date().getFullYear() - 2 + i}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div className={styles.filterGroup}>
                        <select
                            value={paymentTypeFilter}
                            onChange={(e) => setPaymentTypeFilter(e.target.value)}
                            className={styles.filterSelect}
                        >
                            {Object.entries(paymentTypes).map(([key, val]) => (
                                <option key={`type-${key}`} value={key}>{val}</option>
                            ))}
                        </select>
                    </div>

                    <div className={styles.filterGroup}>
                        <select
                            value={statusFilter}
                            onChange={(e) => setStatusFilter(e.target.value)}
                            className={styles.filterSelect}
                        >
                            {Object.entries(statusLabels).map(([key, val]) => (
                                <option key={`status-${key}`} value={key}>{val}</option>
                            ))}
                        </select>
                    </div>
                </div>

                {/* Notification */}
                {notification && (
                    <div className={`${styles.alert} ${
                        notification.type === 'danger' ? styles.alertDanger : styles.alertSuccess
                    }`}>
                        {notification.message}
                    </div>
                )}

                {/* Content */}
                {loading ? (
                    <div className={styles.loading}>
                        <div className={styles.spinner}></div>
                        <p>ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุฏููุนุงุช...</p>
                    </div>
                ) : (
                    <div className={styles.tableContainer}>
                        <table className={styles.table}>
                            <thead>
                            <tr>
                                <th>ุฑูู ุงููุณุชุฎุฏู</th>
                                <th>ุงุณู ุงููุณุชุฎุฏู</th>
                                <th>ููุน ุงูุฏูุน</th>
                                <th>ุงููุจูุบ</th>
                                <th>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                                <th>ุงูุญุงูุฉ</th>
                                <th>ุชุงุฑูุฎ ุงูุฏูุน</th>
                            </tr>
                            </thead>
                            <tbody>
                            {Array.isArray(filteredPayments) && filteredPayments.length > 0 ? (
                                filteredPayments.map((payment) => (
                                    <tr key={`payment-${payment.paymentId}`}>
                                        <td>{payment.userId || '--'}</td>
                                        <td>{payment.fullName || '--'}</td>
                                        <td>{paymentTypes[payment.paymentType] || payment.paymentType || '--'}</td>
                                        <td>{payment.amount !== undefined ? `${payment.amount} ุดููู` : '--'}</td>
                                        <td>{formatDate(payment.date)}</td>
                                        <td>
                                            <span className={`${styles.badge} ${styles[statusVariants[payment.status]] || ''}`}>
                                                {statusLabels[payment.status] || payment.status || '--'}
                                            </span>
                                        </td>
                                        <td>{formatDate(payment.paymentDate)}</td>
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan="7" style={{ textAlign: 'center', padding: '1rem' }}>
                                        ูุง ุชูุฌุฏ ูุฏููุนุงุช ูุนุฑุถูุง
                                    </td>
                                </tr>
                            )}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
};

export default AdminPayments;